<!DOCTYPE HTML>
<html>
  <head>
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <meta name="description" content="a racing game." />
    <title>Game - Racer</title>
	<!--meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densitydpi=medium-dpi" /-->
	<script type="text/javascript" src="js/StageDesign.js"></script>
	<script type="text/javascript" src="js/Sound.js"></script>
	<script src="js/common.js"></script>
    <!-- <script src="js/sound_effects.js"></script> -->
    <script src="js/game_objects.js"></script>
    <script src="js/render.js"></script>
    <script src="js/user_input.js"></script>
    <!-- <script src="js/game.js"></script> -->
    <!-- <script src="js/google_api_js.js"></script> -->
	<script type="text/javascript">
		var canvas;
		var body;
		var w,h;
		
		window.onload = ()=>{
			window.addEventListener("deviceorientation", handleOrientation);
			init();
		}

		function handleOrientation(event) {
			let alpha = event.alpha;
			let beta = event.beta;
			let gamma = event.gamma;
			gamma = prune(gamma, -1, 1);
			gameObjects.car.accel.v1 = gamma;
        }
        
		function init() {
			canvas = document.getElementById('game_canvas');
			body=document.getElementById('body');
			w=canvas.width;
			h=canvas.height;
			initGame();
		}
		
		/*
			변수 설정
		*/
		var imageObj = new Image();

		var ballImgs=[];
		ballImgs[0] = new Image();
		ballImgs[1] = new Image();
		ballImgs[2] = new Image();

		ballImgs[0].src="magicBall.png";
		ballImgs[1].src="blockShape.png";
		ballImgs[2].src="diamond.png";

		// Power Shield Timer
		var powerShield = 0;

		// Score
		var score=0;

		// Remained
		var remained=3;

		// Timer Handler
		var timer;

		// 일시정지 사유
		var stopMode="";

		// 터치 이벤트 버퍼
		var touches=[];

		// 터치 이벤트 처리중인지 여부
		var touchProcessing=false;
		/*

			함수

		*/
		// Initialize
		function initGame(){
			imageObj.src="mainChr_tran.png";
			if (sessionStorage.carStyle=="1")
			{
				imageObj.src="mainChr_tran_purple.png";
			}
			else if (sessionStorage.carStyle=="2")
			{
				imageObj.src="mainChr_tran_red.png";
			}
			body.addEventListener('keydown', ev_keydown, false);
			body.addEventListener('keyup', ev_keyup, false);	

			canvas.addEventListener('touchmove', leftright_touchmove, false);
			
			var ctx = canvas.getContext('2d');

			gameCanvas.init();
			gameObjects.init();
			
			requestAnimationFrame(draw);
		}

		

		function ev_mousedown(ev) {
			if (stopMode=="GameOver")
			{
				stopMode="";
				location.href="HighScore.html?user_score="+score;
			}
			else if (stopMode=="StageCleared")
			{
				stopMode="";
			}
		}

		// Keyboard Event
		var keyPressed=false;
		function ev_keydown(event){ // keyboard alerts
			switch (event.keyCode) {
				case 37: // <-
					keyPressed=true;
					gameObjects.car.accel.v1 = -1;
					break;
				case 38: // Up
					keyPressed=true;

					break;
				case 39: // ->
					keyPressed=true;
					gameObjects.car.accel.v1 = 1;
					break;
				case 40: // Down
					keyPressed=true;
					break;
				case 32: // space
					break;
			}
		}

		function ev_keyup(event){ // keyboard alerts
			switch (event.keyCode) {
				case 37: // <-
				case 38: // Up
				case 39: // ->
				case 40: // Down
					keyPressed=false;
					break;
				case 32: // space
					if (stopMode!="")
					{
						if (stopMode=="GameOver")
						{
							stopMode="";
							sleep(500);
							location.href="HighScore.html?user_score="+score;
						}
						else if (stopMode=="StageCleared")
						{
							stopMode="";
							sleep(500);
						}
						
					}
					break;
			}
		}

		function leftright_touchmove(ev)
		{
			if (touchProcessing)
			{
				return;
			}
			if (stopMode=="")
			{
				ev.preventDefault();
				touches = ev.touches;
			} 
			else
			{			
				if (stopMode=="GameOver")
				{
					stopMode="";
					sleep(500);
					location.href="HighScore.html?user_score="+score;
				}
				else if (stopMode=="StageCleared")
				{
					stopMode="";
					sleep(500);
				}
				
			}
		}

		// Timer Tick
		let last_animation_time = 0;
		function draw(timeStamp){
			if ((timeStamp - last_animation_time) > 30) {
			    last_animation_time = timeStamp;;
				if (canvas.getContext){
					// 터치 이벤트 처리
					touchProcessing=true;
					for (var i=0;i < touches.length;i++)
					{

						var touch = touches[i];
						if(touch.pageX > (gameCanvas.w / 2)) {
							gameObjects.car.accel.v1 = 1;
						}
						else {
							gameObjects.car.accel.v1 = -1;
						}

					}
					touches=[];
					touchProcessing=false;

					gameObjects.render();
					gameObjects.move();
					gameObjects.road.collision_chk(gameObjects.car);
				}
			}

			requestAnimationFrame(draw);
		}

		function sleep(ms)
		{
			var dt = new Date();
			dt.setTime(dt.getTime() + ms);
			while (new Date().getTime() < dt.getTime());
		}
	</script>
  </head>
  <body id="body">
	<canvas id="game_canvas" width="540" height="720"></canvas>
  </body>
</html>
